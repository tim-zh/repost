@(user: Option[User], errors: Seq[FormError] = Nil, entryData: Map[String, String] = Map.empty)
@wrapper(user) {
	<br/>
	<form method="post" action="/entry/save" class="form-horizontal" role="form">
		<input type="hidden" name="id" value="@entryData.get("id").getOrElse(-1)">
		@renderInput(errors, entryData, "title", "title", "text", "title")()
		@renderInput(errors, entryData, "tags", "tags", "text") {
			<span id="tagListContainer"></span>
		}
		<input type="hidden" name="tagsHiddenString" id="tagsHiddenString">
		<div class="form-group">
			<label class="col-xs-offset-2 col-xs-4" for="openForAll">
				<input type="checkbox" name="openForAll" id="openForAll" value=true @*omg, checkbox binding*@
					@(if (entryData.contains("openForAll") && entryData("openForAll") == "true" || !entryData.contains("id")) "checked")>
				open for all
			</label>
		</div>
		<div class="form-group">
			<div class="col-xs-2 col-xs-offset-2">
				<div class="input-group input-group-xs">
					<input type="text" placeholder="image url" class="form-control form-control-xs" id="quickImageUrl">
					<span class="input-group-btn">
						<button type="button" class="btn btn-default btn-xs" id="uploadButton">upload</button>
					</span>
				</div>
			</div>
			<div class="col-xs-2">
					<input type="file" placeholder="image file" class="form-control form-control-xs" name="quickImageFile" id="quickImageFile">
			</div>
		</div>
		<div class="form-group@(if (errors.exists(_.key == "content")) " has-error")">
			<label for="content" class="col-xs-2 control-label">content</label>
			<div class="col-xs-9">
				<textarea class="form-control" name="content" id="content" rows="15"></textarea>
				@defining(errors.filter(_.key == "content").iterator) { i =>
					@for(error <- i) {
						<span class="help-block">@error.message@(if(i.hasNext) ", " else "")</span>
					}
				}
			</div>
		</div>
		<div class="form-group">
			<div class="col-xs-offset-2 col-xs-9">
				@if(entryData.contains("id") && !entryData("id").isEmpty && entryData("id") != "-1") {
					<button type="submit" class="btn btn-success btn-sm">update entry</button>
					<button type="button" class="btn btn-danger btn-sm btn-delete" id="deleteButton">delete entry</button>
				} else {
					<button type="submit" class="btn btn-success btn-sm">add entry</button>
				}
				<button type="button" class="btn btn-default btn-sm" id="cancelButton">cancel</button>
			</div>
		</div>
	</form>
} {
	<script>
		$('#cancelButton').click(function() {window.location='/';});

		@if(entryData.contains("id") && !entryData("id").isEmpty && entryData("id") != "-1") {
			$('#deleteButton').click(function() {
				$.post('/entry/delete', {id: @entryData("id")}, function(response) {
					if ("true" === response)
						window.location = '/';
				});
			});
		}

		var tagList = $('#tagListContainer');
		var tagInput = $('#tags');
		var addTags = function(str) {
			str.
				split(',').
				filter(function(s) {return /^[\w \-]+$/.test(s);}).
				forEach(function(s) {
					var tagName = s.trim();
					var tagString = $('#tagsHiddenString');
					tagString.val(tagString.val() + ',' + tagName);
					$('<a href="#" id="tag' + tagName + '" class="label label-info" style="margin-left:4px;">' + tagName + ' Ã—</a>').
						appendTo(tagList).click(function() {
							var tagNames = tagString.val().split(',');
							tagNames = tagNames.filter(function(e) {return e !== tagName;});
							tagString.val(tagNames.join());
							$('#tag' + tagName).remove();
						});
				}
			);
		};
		tagInput.keypress(function(event) {
			if (event.keyCode == 13 && tagInput.val()) {
				event.preventDefault();
				addTags(tagInput.val());
				tagInput.val("");
			}
		});
		tagInput.autocomplete({
			serviceUrl: '/tags',
			deferRequestBy: 250,
			delimiter: ',',
			onSelect: function(suggestion) {
				addTags(suggestion.value);
				tagInput.val("");
			}
		});
		@if(entryData.contains("tagsHiddenString") && !entryData("tagsHiddenString").isEmpty) {
			addTags('@(entryData("tagsHiddenString"))');
		}

		var contentTextArea = $('#content');
		@if(entryData.contains("content") && !entryData("id").isEmpty && entryData("id") != "-1") {
			var text = '@Html(entryData("content"))';
			[
				[/<br\/>/g, '\r\n'],
				[/<strong>([\s\S]+?)<\/strong>/g, '[b]$1[/b]'],
				[/<i>([\s\S]+?)<\/i>/g, '[i]$1[/i]'],
				[/<u>([\s\S]+?)<\/u>/g, '[u]$1[/u]'],
				[/<s>([\s\S]+?)<\/s>/g, '[s]$1[/s]'],
				[/<font size=(\d+?)>([\s\S]+?)<\/font>/g, '[size=$1]$2[/size]'],
				[/<a href='([\s\S]+?)'>([\s\S]+?)<\/a>/g, '[url=$1]$2[/url]'],
				[/<img src='([\s\S]+?)'\/>/g, '[img]$1[/img]'],
				[/<img width='(\d+?)' height='(\d+?)' src='([\s\S]+?)'\/>/g, '[img=$1,$2]$3[/]'],
				[/<blockquote>([\s\S]+?)<\/blockquote>/g, '[quote]$1[/quote]'],
				[/<ol>([\s\S]+?)<\/ol>/g, '[ol]$1[/ol]'],
				[/<li>([\s\S]+?)<\/li>/g, '[li]$1[/li]'],
				[/<div align='center'>([\s\S]+?)<\/div>/g, '[center]$1[/center]'],
				[/<pre><code>([\s\S]+?)<\/code><\/pre>/g, '[code]$1[/code]'],
				[/<p>([\s\S]+?)<\/p>/g, '[p]$1[/p]']
			].forEach(function(pair) {text = text.replace(pair[0], pair[1])});
			contentTextArea.val(text);
		}
		contentTextArea.sceditor({
			plugins: 'bbcode',
			toolbar: 'bold,italic,underline,strike,size|removeformat|link,image|quote,orderedlist,code,center|date,time|maximize,source',
			style: '@routes.Assets.at("stylesheets/jquery.sceditor.default.min.css")'
		});

		var quickImageUrl = $('#quickImageUrl');
		var uploadButton = $('#uploadButton');
		var isLoading = false;
		var insertImage = function() {
			if (isLoading)
				return;
			isLoading = true;
			uploadButton.text("loading");
			$.get('/image/fromUrl', {url: quickImageUrl.val()}, function(response) {
				if (response) {
					contentTextArea.sceditor('instance').insert('[img]' + response + '[/img]');
					quickImageUrl.val("");
				}
				uploadButton.text("upload");
				isLoading = false;
			});
		};
		quickImageUrl.keypress(function(event) {
			if (event.keyCode == 13 && quickImageUrl.val()) {
				event.preventDefault();
				insertImage();
			}
		});
		uploadButton.click(insertImage);

		var quickImageFile = $('#quickImageFile');
		quickImageFile.change(function() {
			if (isLoading)
				return;
			isLoading = true;
			uploadButton.text("loading");
			var formData = new FormData();
			formData.append('quickImageFile', quickImageFile[0].files[0]);
			$.ajax({
				url:'/image/fromFile',
				type:'POST',
				data: formData,
				processData: false,
				contentType: 'multipart/form-data',
				success: function(response) {
					if (response) {
						contentTextArea.sceditor('instance').insert('[img]' + response + '[/img]');
						quickImageFile.val("");
					}
					uploadButton.text("upload");
					isLoading = false;
				}
			})
		});
	</script>
}